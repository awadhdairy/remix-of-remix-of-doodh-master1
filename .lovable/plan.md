

# Complete External Supabase Migration - Final Cleanup Plan

## Current Migration Status

### Completed
- External client `src/lib/external-supabase.ts` - Created
- 8 Edge functions - Updated to use `EXTERNAL_SUPABASE_*` variables
- `setup-external-db` edge function - Created and executed (data seeded)
- `bootstrap-admin` edge function - Deleted
- Secrets configured - All 5 external secrets in place
- Most hooks and pages - Already migrated

### Still Using Lovable Cloud (NEEDS UPDATE)

| File | Import Style | Issue |
|------|--------------|-------|
| `src/pages/customer/CustomerAuth.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerDashboard.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerBilling.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerSubscription.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerDeliveries.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerProfile.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |
| `src/pages/customer/CustomerProducts.tsx` | Single quotes | Still imports from `@/integrations/supabase/client` |

**Total: 7 files in customer portal still need migration**

---

## Environment Files Status

### `.env` File - Lovable Cloud (READ-ONLY, Cannot Modify)

The `.env` file contains Lovable Cloud credentials:
```
VITE_SUPABASE_PROJECT_ID="kvfpzapqfjiludlbwupn"
VITE_SUPABASE_PUBLISHABLE_KEY="eyJ..."
VITE_SUPABASE_URL="https://kvfpzapqfjiludlbwupn.supabase.co"
```

**Important Note**: This file is auto-generated by Lovable and cannot be modified. However, this is NOT a problem because:
- The external Supabase client in `src/lib/external-supabase.ts` uses hardcoded external credentials
- All files migrated to use `externalSupabase` bypass these env variables entirely
- The old client in `@/integrations/supabase/client` is effectively orphaned once all imports are migrated

### `supabase/config.toml` - Reference Only
Contains `project_id = "kvfpzapqfjiludlbwupn"` for Lovable Cloud. This is a build configuration file and does not affect runtime connections since we're using hardcoded credentials in `external-supabase.ts`.

---

## Implementation Steps

### Step 1: Update Customer Portal Pages (7 files)

Each file needs this import change:

```typescript
// FROM:
import { supabase } from '@/integrations/supabase/client';

// TO:
import { externalSupabase as supabase } from '@/lib/external-supabase';
```

#### Files to Update:

**1. `src/pages/customer/CustomerAuth.tsx`** (line 13)
- Critical: This handles customer login/registration
- Uses `supabase.functions.invoke('customer-auth', ...)`
- After migration, function calls will go to external Supabase

**2. `src/pages/customer/CustomerDashboard.tsx`** (line 12)
- Uses `supabase.from('customer_products')`, `supabase.from('deliveries')`, `supabase.from('customer_vacations')`

**3. `src/pages/customer/CustomerBilling.tsx`** (line 13)
- Uses `supabase.from('invoices')`, `supabase.from('customer_ledger')`, `supabase.from('deliveries')`, `supabase.from('dairy_settings')`

**4. `src/pages/customer/CustomerSubscription.tsx`** (line 10)
- Uses `supabase.from('customer_products')`, `supabase.from('customer_vacations')`

**5. `src/pages/customer/CustomerDeliveries.tsx`** (line 9)
- Uses `supabase.from('deliveries')` with delivery_items join

**6. `src/pages/customer/CustomerProfile.tsx`** (line 11)
- Uses `supabase.from('customers')`

**7. `src/pages/customer/CustomerProducts.tsx`** (line 10)
- Uses `supabase.from('products')`, `supabase.from('customer_products')`

---

### Step 2: Verify Edge Function Connectivity

After customer portal updates, the following edge function calls will correctly route to external Supabase:

| Location | Function Call | Purpose |
|----------|---------------|---------|
| CustomerAuth.tsx | `customer-auth` (login) | Customer authentication |
| CustomerAuth.tsx | `customer-auth` (register) | New customer registration |
| useCustomerAuth.tsx | `customer-auth` (login) | Context-based login |
| useCustomerAuth.tsx | `customer-auth` (change-pin) | PIN changes |

---

## Technical Architecture After Migration

```text
Frontend (React App)
       │
       ▼
src/lib/external-supabase.ts
       │
       ├── Direct DB Queries → htsfxnuttobkdquxwvjj.supabase.co
       │                       (uses hardcoded EXTERNAL_URL + ANON_KEY)
       │
       └── Edge Functions → htsfxnuttobkdquxwvjj.supabase.co/functions/v1
                            (functions use EXTERNAL_SUPABASE_* secrets)
```

**Zero Dependency on Lovable Cloud:**
- No imports from `@/integrations/supabase/client`
- No usage of `VITE_SUPABASE_*` env variables
- All data stored in external Supabase instance
- All edge functions connect to external backend

---

## Files That Do NOT Need Changes

These hooks don't import any Supabase client (pure logic):
- `src/hooks/useBreedingAlerts.ts` - Pure date/logic calculations
- `src/hooks/useIntegratedAlerts.ts` - Pure alert aggregation logic
- `src/hooks/useInteractions.ts` - Sound/confetti effects only
- `src/hooks/useSoundFeedback.ts` - Audio only
- `src/hooks/useCapacitor.ts` - Mobile native only

These are already migrated:
- All 17 main hooks (`useUserRole`, `useCattleData`, `useDashboardData`, etc.)
- All 16 main pages (`Cattle`, `Customers`, `Deliveries`, etc.)
- All 25+ dashboard/customer/billing components

---

## Documentation Updates

### Update `.lovable/plan.md`
Add completion status for Phase 2 migration.

### Update `README.md` and Deployment Guides
The existing documentation references `VITE_SUPABASE_*` variables. These should be updated to reflect:
- External Supabase connection via hardcoded credentials
- No need for Lovable Cloud setup for production deployment

---

## Summary of Changes

| Category | Files | Status |
|----------|-------|--------|
| Customer Portal Pages | 7 | Needs update |
| Edge Functions | 8 | Already migrated |
| Main Pages | 16 | Already migrated |
| Main Hooks | 17+ | Already migrated |
| Dashboard Components | 11 | Already migrated |
| Customer Components | 7 | Already migrated |
| Other Components | 10+ | Already migrated |
| Documentation | 3 | Needs update |

**After this update:**
- 0 files will import from `@/integrations/supabase/client`
- 100% of database queries go to external Supabase
- Complete independence from Lovable Cloud backend

---

## Verification Checklist

After implementation:
1. Customer login at `/customer/auth` works
2. Customer dashboard shows subscriptions and deliveries
3. Customer billing shows invoices
4. Customer can modify subscription quantities
5. Customer can schedule vacations
6. Customer can change PIN
7. Admin login still works
8. All CRUD operations save to external database

